# =================================================================================
# Android CI/CD å·¥ä½œæµ
# ---------------------------------------------------------------------------------
# å½“ä»£ç è¢«æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œæ­¤å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘ã€‚
# å®ƒä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# 1. è®¾ç½® Java å’Œ Gradle ç¯å¢ƒã€‚
# 2. ä½¿ç”¨ Gradle æ„å»ºå¹¶ç­¾å Release ç‰ˆæœ¬çš„ APKã€‚
# 3. è®¡ç®—æ„å»ºäº§ç‰©çš„ SHA256 å“ˆå¸Œå€¼å¹¶ç”Ÿæˆæ„å»ºæ‘˜è¦ã€‚
# 4. å°†æ‰€æœ‰ APK å’Œå…ƒæ•°æ®æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ ã€‚
# 5. å‘é€æ„å»ºç»“æœå’Œ APK æ–‡ä»¶åˆ°æŒ‡å®šçš„ Telegram é¢‘é“ã€‚
# =================================================================================

name: Android CI

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ "master" ]
    # å½“æ¨é€ä»…æ¶‰åŠä»¥ä¸‹æ–‡ä»¶ç±»å‹æ—¶ï¼Œä¸è§¦å‘å·¥ä½œæµï¼Œä»¥èŠ‚çœèµ„æºã€‚
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - '.github/*'
      - '.idea/**'
      - '!.github/workflows/**' # ä¾‹å¤–è§„åˆ™ï¼šç¡®ä¿å¯¹å·¥ä½œæµæœ¬èº«çš„ä¿®æ”¹èƒ½è§¦å‘ CI

# ä¸ºå·¥ä½œæµä¸­çš„æ‰€æœ‰ä½œä¸šè®¾ç½®é»˜è®¤æƒé™ã€‚
permissions:
  contents: write # å…è®¸å†™å…¥å†…å®¹ï¼Œä¾‹å¦‚åˆ›å»º GitHub Releaseã€‚
  actions: write  # å…è®¸æ“ä½œ Actionsï¼Œä¾‹å¦‚å–æ¶ˆå·¥ä½œæµã€‚
  packages: write # å…è®¸å†™å…¥ GitHub Packagesã€‚

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  build-and-release: # ä½œä¸šçš„å”¯ä¸€ID

    runs-on: ubuntu-latest # æŒ‡å®šä½œä¸šè¿è¡Œåœ¨æœ€æ–°ç‰ˆçš„ Ubuntu è™šæ‹Ÿç¯å¢ƒä¸­ã€‚

    steps:
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²æäº¤è®°å½•ï¼Œä»¥ä¾¿ `git rev-list` å¯ä»¥æ­£ç¡®è®¡ç®—ç‰ˆæœ¬å·ã€‚

      # ç¬¬ 2 æ­¥ï¼šè®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'        # æŒ‡å®š Java ç‰ˆæœ¬ä¸º 21ã€‚
          distribution: 'temurin'   # ä½¿ç”¨ Eclipse Temurin å‘è¡Œç‰ˆã€‚
          cache: gradle             # å¯ç”¨ Gradle ä¾èµ–é¡¹çš„ç¼“å­˜ï¼Œä»¥åŠ å¿«åç»­æ„å»ºé€Ÿåº¦ã€‚

      # ç¬¬ 3 æ­¥ï¼šè®¾ç½®ç­¾åå¯†é’¥åº“
      - name: Setup Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks

      # ç¬¬ 4 æ­¥ï¼šæ„å»ºå¹¶ç­¾ååº”ç”¨
      - name: Build with Gradle
        run: |
          chmod +x gradlew # æˆäºˆ gradlew è„šæœ¬æ‰§è¡Œæƒé™ã€‚
          ./gradlew assembleRelease
        env:
          KEYSTORE_PATH: "../keystore.jks"
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # ç¬¬ 5 æ­¥ï¼šå‡†å¤‡æ„å»ºäº§ç‰©ä¿¡æ¯
      - name: Prepare Artifacts and Generate Summary
        id: artifacts
        run: |
          apk_dir="app/build/outputs/apk/release"
          apk_file_armeabi=$(find "$apk_dir" -name 'OShin_armeabi-v7a_v*.apk')
          apk_file_arm64=$(find "$apk_dir" -name 'OShin_arm64-v8a_v*.apk')
          apk_file_armall=$(find "$apk_dir" -name 'OShin_all_v*.apk')
          
          # æ·»åŠ ä¸€ä¸ªæ£€æŸ¥ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶å°±è®©å·¥ä½œæµå¤±è´¥ï¼Œè€Œä¸æ˜¯é™é»˜åœ°ç»§ç»­ã€‚
          if [ -z "$apk_file_armall" ]; then
            echo "::error::Universal APK not found! Build may have failed to produce artifacts."
            exit 1
          fi
          
          # å°†æ–‡ä»¶è·¯å¾„å¯¼å‡ºåˆ° GITHUB_ENVï¼Œä¾›åç»­æ­¥éª¤ï¼ˆå¦‚ Telegram é€šçŸ¥ï¼‰ä½¿ç”¨ã€‚
          echo "APK_FILE_ARMEABI=$apk_file_armeabi" >> $GITHUB_ENV
          echo "APK_FILE_ARM64=$apk_file_arm64" >> $GITHUB_ENV
          echo "APK_FILE_ARMALL=$apk_file_armall" >> $GITHUB_ENV
          
          # ä½¿ç”¨å¯é çš„æœ¬åœ°å˜é‡è®¡ç®— SHA256 å“ˆå¸Œå€¼ã€‚
          sha_armeabi=$(sha256sum "$apk_file_armeabi" | awk '{print $1}')
          sha_arm64=$(sha256sum "$apk_file_arm64" | awk '{print $1}')
          sha_armall=$(sha256sum "$apk_file_armall" | awk '{print $1}')
          
          # å°†å“ˆå¸Œå€¼è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡ºï¼ˆGITHUB_OUTPUTï¼‰ï¼Œä»¥ä¾¿åœ¨å…¶ä»–æ­¥éª¤ä¸­é€šè¿‡ steps.artifacts.outputs.sha_... å¼•ç”¨ã€‚
          echo "sha_armeabi=$sha_armeabi" >> $GITHUB_OUTPUT
          echo "sha_arm64=$sha_arm64" >> $GITHUB_OUTPUT
          echo "sha_armall=$sha_armall" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆå°†åœ¨ GitHub Actions æ‘˜è¦é¡µé¢æ˜¾ç¤ºçš„ Markdown è¡¨æ ¼ã€‚
          {
            echo "### OShin æ„å»ºæˆåŠŸ :rocket:"
            echo ""
            echo "| æ¶æ„ | SHA256 å“ˆå¸Œ |"
            echo "|:---|:---|"
            echo "| armeabi-v7a | \`$sha_armeabi\` |"
            echo "| arm64-v8a | \`$sha_arm64\` |"
            echo "| all | \`$sha_armall\` |"
          } >> $GITHUB_STEP_SUMMARY

      # ç¬¬ 6 æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OShin-Build-${{ github.sha }} # ä¸ºäº§ç‰©åŒ…æŒ‡å®šä¸€ä¸ªåŒ…å«æäº¤IDçš„å”¯ä¸€åç§°ã€‚
          path: app/build/outputs/apk/release/ # ä¸Šä¼  release ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚

      - name: Get and escape submission information
        id: prepare_message
        run: |
          commit_msg="$(git log -1 --pretty=format:%B)"

          escaped_msg=$(echo "$commit_msg" | sed -e 's/[]\[_*()~`>#+=|{}.!-]/\\&/g')

          echo "escaped_commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$escaped_msg" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Notification to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          document: ${{ env.APK_FILE_ARMALL }}
          debug: true
          format: markdown
          message: |
            ğŸš€ **OShin New CI Buildï¼**

            ${{ steps.prepare_message.outputs.escaped_commit_msg }}

            ğŸ”— [æŸ¥çœ‹æœ¬æ¬¡æäº¤](${{ github.event.head_commit.url }})
