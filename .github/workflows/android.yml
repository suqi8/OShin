# =================================================================================
# Android CI/CD å·¥ä½œæµ
# ---------------------------------------------------------------------------------
# å½“ä»£ç è¢«æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œæ­¤å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘ã€‚
# å®ƒä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# 1. è®¾ç½® Java å’Œ Gradle ç¯å¢ƒã€‚
# 2. ä½¿ç”¨ Gradle æ„å»ºå¹¶ç­¾å Release ç‰ˆæœ¬çš„ APKã€‚
# 3. è®¡ç®—æ„å»ºäº§ç‰©çš„ SHA256 å“ˆå¸Œå€¼å¹¶ç”Ÿæˆæ„å»ºæ‘˜è¦ã€‚
# 4. å°†æ‰€æœ‰ APK å’Œå…ƒæ•°æ®æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ ã€‚
# 5. å‘é€æ„å»ºç»“æœå’Œ APK æ–‡ä»¶åˆ°æŒ‡å®šçš„ Telegram é¢‘é“ã€‚
# =================================================================================

name: Android CI

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ "master" ]
    # å½“æ¨é€ä»…æ¶‰åŠä»¥ä¸‹æ–‡ä»¶ç±»å‹æ—¶ï¼Œä¸è§¦å‘å·¥ä½œæµï¼Œä»¥èŠ‚çœèµ„æºã€‚
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - '.github/*'
      - '.idea/**'
      - '!.github/workflows/**' # ä¾‹å¤–è§„åˆ™ï¼šç¡®ä¿å¯¹å·¥ä½œæµæœ¬èº«çš„ä¿®æ”¹èƒ½è§¦å‘ CI

# ä¸ºå·¥ä½œæµä¸­çš„æ‰€æœ‰ä½œä¸šè®¾ç½®é»˜è®¤æƒé™ã€‚
permissions:
  contents: write # å…è®¸å†™å…¥å†…å®¹ï¼Œä¾‹å¦‚åˆ›å»º GitHub Releaseã€‚
  actions: write  # å…è®¸æ“ä½œ Actionsï¼Œä¾‹å¦‚å–æ¶ˆå·¥ä½œæµã€‚
  packages: write # å…è®¸å†™å…¥ GitHub Packagesã€‚

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  build-and-release: # ä½œä¸šçš„å”¯ä¸€ID

    runs-on: ubuntu-latest # æŒ‡å®šä½œä¸šè¿è¡Œåœ¨æœ€æ–°ç‰ˆçš„ Ubuntu è™šæ‹Ÿç¯å¢ƒä¸­ã€‚

    steps:
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡ºä»£ç 
      # `actions/checkout` ç”¨äºä»ä»“åº“ä¸­æ‹‰å–ä»£ç ã€‚
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²æäº¤è®°å½•ï¼Œä»¥ä¾¿ `git rev-list` å¯ä»¥æ­£ç¡®è®¡ç®—ç‰ˆæœ¬å·ã€‚

      # ç¬¬ 2 æ­¥ï¼šè®¾ç½® JDK ç¯å¢ƒ
      # `actions/setup-java` ç”¨äºå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Javaã€‚
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'        # æŒ‡å®š Java ç‰ˆæœ¬ä¸º 21ã€‚
          distribution: 'temurin'   # ä½¿ç”¨ Eclipse Temurin å‘è¡Œç‰ˆã€‚
          cache: gradle             # å¯ç”¨ Gradle ä¾èµ–é¡¹çš„ç¼“å­˜ï¼Œä»¥åŠ å¿«åç»­æ„å»ºé€Ÿåº¦ã€‚

      # ç¬¬ 3 æ­¥ï¼šè®¾ç½®ç­¾åå¯†é’¥åº“
      # ä» GitHub Secrets ä¸­è§£ç  Base64 ç¼–ç çš„å¯†é’¥åº“æ–‡ä»¶ã€‚
      - name: Setup Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks

      # ç¬¬ 4 æ­¥ï¼šæ„å»ºå¹¶ç­¾ååº”ç”¨
      # æ‰§è¡Œ Gradle æ„å»ºä»»åŠ¡æ¥ç”Ÿæˆå·²ç­¾åçš„ Release APKã€‚
      - name: Build with Gradle
        run: |
          chmod +x gradlew # æˆäºˆ gradlew è„šæœ¬æ‰§è¡Œæƒé™ã€‚
          ./gradlew assembleRelease
        env:
          # å°†ç­¾åæ‰€éœ€çš„ä¿¡æ¯ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ç»™ Gradleã€‚
          # è¿™äº›ä¿¡æ¯åº”åœ¨ GitHub ä»“åº“çš„ Settings > Secrets and variables > Actions ä¸­é…ç½®ã€‚
          KEYSTORE_PATH: "../keystore.jks"
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # ç¬¬ 5 æ­¥ï¼šå‡†å¤‡æ„å»ºäº§ç‰©ä¿¡æ¯
      # æŸ¥æ‰¾æ„å»ºç”Ÿæˆçš„ APK å’Œå…ƒæ•°æ®æ–‡ä»¶ï¼Œè®¡ç®—å…¶ SHA256 å“ˆå¸Œå€¼ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ ¼å¼åŒ–çš„æ„å»ºæ‘˜è¦ã€‚
      - name: Prepare Artifacts and Generate Summary
        id: artifacts # ä¸ºæ­¤æ­¥éª¤è®¾ç½®ä¸€ä¸ª IDï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¯ä»¥å¼•ç”¨å…¶è¾“å‡ºã€‚
        run: |
          # æŸ¥æ‰¾æ–‡ä»¶å¹¶å°†å…¶è·¯å¾„å¯¼å‡ºåˆ° GITHUB_ENVï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨ã€‚
          apk_dir="app/build/outputs/apk/release"
          echo "APK_FILE_ARMEABI=$(find $apk_dir -name 'OShin_armeabi-v7a_v*.apk')" >> $GITHUB_ENV
          echo "APK_FILE_ARM64=$(find $apk_dir -name 'OShin_arm64-v8a_v*.apk')" >> $GITHUB_ENV
          echo "APK_FILE_ARMALL=$(find $apk_dir -name 'OShin_all_v*.apk')" >> $GITHUB_ENV
          
          # è®¡ç®— SHA256 å“ˆå¸Œå€¼
          sha_armeabi=$(sha256sum $APK_FILE_ARMEABI | awk '{print $1}')
          sha_arm64=$(sha256sum $APK_FILE_ARM64 | awk '{print $1}')
          sha_armall=$(sha256sum $APK_FILE_ARMALL | awk '{print $1}')
          
          # å°†å“ˆå¸Œå€¼è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡ºï¼Œä»¥ä¾¿åœ¨å…¶ä»–æ­¥éª¤ä¸­å¼•ç”¨ã€‚
          echo "sha_armeabi=$sha_armeabi" >> $GITHUB_OUTPUT
          echo "sha_arm64=$sha_arm64" >> $GITHUB_OUTPUT
          echo "sha_armall=$sha_armall" >> $GITHUB_OUTPUT
          
          # ä½¿ç”¨ Markdown æ ¼å¼åŒ–æ„å»ºæ‘˜è¦ï¼Œå¹¶å†™å…¥ GITHUB_STEP_SUMMARYã€‚
          # æ­¤æ‘˜è¦å°†æ˜¾ç¤ºåœ¨ GitHub Actions çš„ä½œä¸šæ‘˜è¦é¡µé¢ã€‚
          {
            echo "### OShin æ„å»ºæˆåŠŸ :rocket:"
            echo ""
            echo "| æ¶æ„ | SHA256 å“ˆå¸Œ |"
            echo "|:---|:---|"
            echo "| armeabi-v7a | \`$sha_armeabi\` |"
            echo "| arm64-v8a | \`$sha_arm64\` |"
            echo "| all | \`$sha_armall\` |"
          } >> $GITHUB_STEP_SUMMARY

      # ç¬¬ 6 æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      # å°†æ‰€æœ‰ç”Ÿæˆçš„ APK å’Œå…ƒæ•°æ®æ–‡ä»¶æ‰“åŒ…ä¸Šä¼ ï¼Œä»¥ä¾¿åœ¨å·¥ä½œæµç»“æŸåå¯ä»¥ä¸‹è½½ã€‚
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OShin-Build-${{ github.sha }} # ä¸ºäº§ç‰©åŒ…æŒ‡å®šä¸€ä¸ªåŒ…å«æäº¤IDçš„å”¯ä¸€åç§°ã€‚
          path: app/build/outputs/apk/release/ # ä¸Šä¼  release ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚

      # ç¬¬ 7 æ­¥ï¼šå‘é€é€šçŸ¥åˆ° Telegram
      - name: Send Notification to Telegram
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_TO }} # Telegram æ¥æ”¶è€…çš„ Chat IDï¼Œå»ºè®®é…ç½®ä¸º Secretã€‚
          token: ${{ secrets.TELEGRAM_TOKEN }} # Telegram Bot çš„ Tokenï¼Œå¿…é¡»é…ç½®ä¸º Secretã€‚
          document: ${{ env.APK_FILE_ARMALL }} # å°†åŒ…å«æ‰€æœ‰æ¶æ„çš„ APK ä½œä¸ºæ–‡ä»¶å‘é€ã€‚
          # æ ¼å¼åŒ–çš„æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒ Markdownã€‚
          message: |
            ğŸš€ **OShin æ–°ç‰ˆæœ¬æ„å»ºå®Œæˆï¼**
            
            **æäº¤ä¿¡æ¯:**
            \`\`\`
            ${{ github.event.head_commit.message }}
            \`\`\`
            
            **æ„å»ºè¯¦æƒ…:**
            - **armeabi-v7a:** `${{ steps.artifacts.outputs.sha_armeabi }}`
            - **arm64-v8a:** `${{ steps.artifacts.outputs.sha_arm64 }}`
            - **all:** `${{ steps.artifacts.outputs.sha_armall }}`
            
            ğŸ”— **æŸ¥çœ‹æœ¬æ¬¡æäº¤:** [${{ github.sha }}](${{ github.event.head_commit.url }})
