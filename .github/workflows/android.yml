# =================================================================================
# Android CI/CD å·¥ä½œæµ
# ---------------------------------------------------------------------------------
# å½“ä»£ç è¢«æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œæ­¤å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘ã€‚
# å®ƒä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# 1. è®¾ç½® Java å’Œ Gradle ç¯å¢ƒã€‚
# 2. ä½¿ç”¨ Gradle æ„å»ºå¹¶ç­¾å Release ç‰ˆæœ¬çš„ APKã€‚
# 3. è®¡ç®—æ„å»ºäº§ç‰©çš„ SHA256 å“ˆå¸Œå€¼å¹¶ç”Ÿæˆæ„å»ºæ‘˜è¦ã€‚
# 4. å°†æ‰€æœ‰ APK å’Œå…ƒæ•°æ®æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ ã€‚
# 5. å‘é€æ„å»ºç»“æœå’Œ APK æ–‡ä»¶åˆ°æŒ‡å®šçš„ Telegram é¢‘é“ã€‚
# =================================================================================

name: Android CI

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ "master" ]
    # å½“æ¨é€ä»…æ¶‰åŠä»¥ä¸‹æ–‡ä»¶ç±»å‹æ—¶ï¼Œä¸è§¦å‘å·¥ä½œæµï¼Œä»¥èŠ‚çœèµ„æºã€‚
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - '.github/*'
      - '.idea/**'
      - '!.github/workflows/**' # ä¾‹å¤–è§„åˆ™ï¼šç¡®ä¿å¯¹å·¥ä½œæµæœ¬èº«çš„ä¿®æ”¹èƒ½è§¦å‘ CI

# ä¸ºå·¥ä½œæµä¸­çš„æ‰€æœ‰ä½œä¸šè®¾ç½®é»˜è®¤æƒé™ã€‚
permissions:
  contents: write # å…è®¸å†™å…¥å†…å®¹ï¼Œä¾‹å¦‚åˆ›å»º GitHub Releaseã€‚
  actions: write  # å…è®¸æ“ä½œ Actionsï¼Œä¾‹å¦‚å–æ¶ˆå·¥ä½œæµã€‚
  packages: write # å…è®¸å†™å…¥ GitHub Packagesã€‚

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  build-and-release: # ä½œä¸šçš„å”¯ä¸€ID

    runs-on: ubuntu-latest # æŒ‡å®šä½œä¸šè¿è¡Œåœ¨æœ€æ–°ç‰ˆçš„ Ubuntu è™šæ‹Ÿç¯å¢ƒä¸­ã€‚

    steps:
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²æäº¤è®°å½•ï¼Œä»¥ä¾¿ `git rev-list` å¯ä»¥æ­£ç¡®è®¡ç®—ç‰ˆæœ¬å·ã€‚

      # ç¬¬ 2 æ­¥ï¼šè®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'        # æŒ‡å®š Java ç‰ˆæœ¬ä¸º 21ã€‚
          distribution: 'temurin'   # ä½¿ç”¨ Eclipse Temurin å‘è¡Œç‰ˆã€‚
          cache: gradle             # å¯ç”¨ Gradle ä¾èµ–é¡¹çš„ç¼“å­˜ï¼Œä»¥åŠ å¿«åç»­æ„å»ºé€Ÿåº¦ã€‚

      # ç¬¬ 3 æ­¥ï¼šè®¾ç½®ç­¾åå¯†é’¥åº“
      - name: Setup Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks

      # ç¬¬ 4 æ­¥ï¼šæ„å»ºå¹¶ç­¾ååº”ç”¨
      - name: Build with Gradle
        run: |
          chmod +x gradlew # æˆäºˆ gradlew è„šæœ¬æ‰§è¡Œæƒé™ã€‚
          ./gradlew assembleRelease
        env:
          KEYSTORE_PATH: "../keystore.jks"
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # ç¬¬ 5 æ­¥ï¼šå‡†å¤‡æ„å»ºäº§ç‰©ä¿¡æ¯
      - name: Prepare Artifacts and Generate Summary
        id: artifacts
        run: |
          apk_dir="app/build/outputs/apk/release"
          apk_file_armeabi=$(find "$apk_dir" -name 'OShin_armeabi-v7a_v*.apk')
          apk_file_arm64=$(find "$apk_dir" -name 'OShin_arm64-v8a_v*.apk')
          apk_file_armall=$(find "$apk_dir" -name 'OShin_all_v*.apk')
          
          if [ -z "$apk_file_armall" ]; then
            echo "::error::Universal APK not found! Build may have failed to produce artifacts."
            exit 1
          fi
          
          echo "APK_FILE_ARMEABI=$apk_file_armeabi" >> $GITHUB_ENV
          echo "APK_FILE_ARM64=$apk_file_arm64" >> $GITHUB_ENV
          echo "APK_FILE_ARMALL=$apk_file_armall" >> $GITHUB_ENV
          
          sha_armeabi=$(sha256sum "$apk_file_armeabi" | awk '{print $1}')
          sha_arm64=$(sha256sum "$apk_file_arm64" | awk '{print $1}')
          sha_armall=$(sha256sum "$apk_file_armall" | awk '{print $1}')
          
          echo "sha_armeabi=$sha_armeabi" >> $GITHUB_OUTPUT
          echo "sha_arm64=$sha_arm64" >> $GITHUB_OUTPUT
          echo "sha_armall=$sha_armall" >> $GITHUB_OUTPUT
          
          {
            echo "### OShin æ„å»ºæˆåŠŸ :rocket:"
            echo ""
            echo "| æ¶æ„ | SHA256 å“ˆå¸Œ |"
            echo "|:---|:---|"
            echo "| armeabi-v7a | \`$sha_armeabi\` |"
            echo "| arm64-v8a | \`$sha_arm64\` |"
            echo "| all | \`$sha_armall\` |"
          } >> $GITHUB_STEP_SUMMARY

      # ç¬¬ 6 æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OShin-Build-${{ github.sha }}
          path: app/build/outputs/apk/release/

      # ç¬¬ 7 æ­¥ï¼šå‘é€é€šçŸ¥åˆ° Telegram
      - name: Send Notification to Telegram
        env:
          # å®šä¹‰è¦å‘é€çš„æ¶ˆæ¯å†…å®¹
          TELEGRAM_MESSAGE: |
            ğŸš€ **OShin æ–°ç‰ˆæœ¬æ„å»ºå®Œæˆï¼**
            
            **æäº¤ä¿¡æ¯:**
            ```
            ${{ github.event.head_commit.message }}
            ```
            ğŸ”— **æŸ¥çœ‹æœ¬æ¬¡æäº¤:** [${{ github.sha }}](${{ github.event.head_commit.url }})
        run: |
          # ä½¿ç”¨ Python å¯¹æ¶ˆæ¯å†…å®¹è¿›è¡Œè½¬ä¹‰å’Œç¼–ç ï¼Œä»¥é€‚é… Telegram API çš„ sendMediaGroup URL å‚æ•°æ ¼å¼
          ESCAPED_MESSAGE=$(python3 -c '
          import json, os, re, urllib.parse;
          msg = os.environ["TELEGRAM_MESSAGE"];
          # ä¸º MarkdownV2 è½¬ä¹‰æ‰€æœ‰å¿…è¦çš„ç‰¹æ®Šå­—ç¬¦
          escape_chars = r"_[]()~`>#+-=|{}.!";
          for char in escape_chars:
              msg = msg.replace(char, "\\" + char);
          # ä½¿ç”¨ json.dumps å¤„ç†å¼•å·ç­‰ï¼Œç„¶åè¿›è¡Œ URL ç¼–ç 
          print(urllib.parse.quote(json.dumps(msg)));
          ')
          
          # ä½¿ç”¨ curl è°ƒç”¨ sendMediaGroup æ–¹æ³•å‘é€å¸¦æ–‡ä»¶çš„æ¶ˆæ¯
          # è¿™æ˜¯ç”¨æˆ·åŸå§‹å·¥ä½œæµä¸­éªŒè¯è¿‡å¯ä»¥æˆåŠŸå‘é€çš„æ–¹æ³•
          curl "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMediaGroup?chat_id=${{ secrets.TELEGRAM_TO }}&media=%5B%7B%22type%22%3A%22document%22%2C%22media%22%3A%22attach%3A%2F%2Fapkfile%22%2C%22parse_mode%22%3A%22MarkdownV2%22%2C%22caption%22%3A$ESCAPED_MESSAGE%7D%5D" \
               -F apkfile=@"${{ env.APK_FILE_ARMALL }}"
