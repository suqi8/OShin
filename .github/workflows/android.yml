# =================================================================================
# Android CI/CD å·¥ä½œæµ
# ---------------------------------------------------------------------------------
# å½“ä»£ç è¢«æ¨é€åˆ° master åˆ†æ”¯æ—¶ï¼Œæ­¤å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘ã€‚
# å®ƒä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
# 1. è®¾ç½® Java å’Œ Gradle ç¯å¢ƒã€‚
# 2. ä½¿ç”¨ Gradle æ„å»ºå¹¶ç­¾å Release ç‰ˆæœ¬çš„ APKã€‚
# 3. è®¡ç®—æ„å»ºäº§ç‰©çš„ SHA256 å“ˆå¸Œå€¼å¹¶ç”Ÿæˆæ„å»ºæ‘˜è¦ã€‚
# 4. å°†æ‰€æœ‰ APK å’Œå…ƒæ•°æ®æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ ã€‚
# 5. å‘é€æ„å»ºç»“æœå’Œ APK æ–‡ä»¶åˆ°æŒ‡å®šçš„ Telegram é¢‘é“ã€‚
# =================================================================================

name: Android CI

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ "master" ]
    # å½“æ¨é€ä»…æ¶‰åŠä»¥ä¸‹æ–‡ä»¶ç±»å‹æ—¶ï¼Œä¸è§¦å‘å·¥ä½œæµï¼Œä»¥èŠ‚çœèµ„æºã€‚
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - '.github/*'
      - '.idea/**'
      - '!.github/workflows/**' # ä¾‹å¤–è§„åˆ™ï¼šç¡®ä¿å¯¹å·¥ä½œæµæœ¬èº«çš„ä¿®æ”¹èƒ½è§¦å‘ CI

# ä¸ºå·¥ä½œæµä¸­çš„æ‰€æœ‰ä½œä¸šè®¾ç½®é»˜è®¤æƒé™ã€‚
permissions:
  contents: write # å…è®¸å†™å…¥å†…å®¹ï¼Œä¾‹å¦‚åˆ›å»º GitHub Releaseã€‚
  actions: write  # å…è®¸æ“ä½œ Actionsï¼Œä¾‹å¦‚å–æ¶ˆå·¥ä½œæµã€‚
  packages: write # å…è®¸å†™å…¥ GitHub Packagesã€‚

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  build-and-release: # ä½œä¸šçš„å”¯ä¸€ID

    runs-on: ubuntu-latest # æŒ‡å®šä½œä¸šè¿è¡Œåœ¨æœ€æ–°ç‰ˆçš„ Ubuntu è™šæ‹Ÿç¯å¢ƒä¸­ã€‚

    steps:
      # ç¬¬ 1 æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²æäº¤è®°å½•ï¼Œä»¥ä¾¿ `git rev-list` å¯ä»¥æ­£ç¡®è®¡ç®—ç‰ˆæœ¬å·ã€‚

      # ç¬¬ 2 æ­¥ï¼šè®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'        # æŒ‡å®š Java ç‰ˆæœ¬ä¸º 21ã€‚
          distribution: 'temurin'   # ä½¿ç”¨ Eclipse Temurin å‘è¡Œç‰ˆã€‚
          cache: gradle             # å¯ç”¨ Gradle ä¾èµ–é¡¹çš„ç¼“å­˜ï¼Œä»¥åŠ å¿«åç»­æ„å»ºé€Ÿåº¦ã€‚

      # ç¬¬ 3 æ­¥ï¼šè®¾ç½®ç­¾åå¯†é’¥åº“
      - name: Setup Keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.jks

      # ç¬¬ 4 æ­¥ï¼šæ„å»ºå¹¶ç­¾ååº”ç”¨
      - name: Build with Gradle
        run: |
          chmod +x gradlew # æˆäºˆ gradlew è„šæœ¬æ‰§è¡Œæƒé™ã€‚
          ./gradlew assembleRelease
        env:
          KEYSTORE_PATH: "../keystore.jks"
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      # ç¬¬ 5 æ­¥ï¼šå‡†å¤‡æ„å»ºäº§ç‰©ä¿¡æ¯
      - name: Prepare Artifacts, Extract Version String, and Generate Summary
        id: artifacts
        run: |
            apk_dir="app/build/outputs/apk/release"
            apk_file_v8a=$(find "$apk_dir" -name 'OShin_arm64-v8a_v*.apk')
            if [ -z "$apk_file_v8a" ]; then
              echo "::error::arm64-v8a APK not found!"
              exit 1
            fi
            echo "APK_FILE_V8A=$apk_file_v8a" >> $GITHUB_ENV
          
            # æå–å®Œæ•´æ–‡ä»¶å
            apk_filename=$(basename "$apk_file_v8a")
            echo "Extracted filename: $apk_filename"
          
            # ç§»é™¤å‰ç¼€ "OShin_arm64-v8a_"
            version_with_suffix="${apk_filename#OShin_arm64-v8a_}"
            echo "Version with suffix: $version_with_suffix"
          
            # ç§»é™¤åç¼€ ".apk" å¾—åˆ°æœ€ç»ˆçš„ç‰ˆæœ¬å­—ç¬¦ä¸²
            version_string="${version_with_suffix%.apk}"
            echo "Extracted version string: $version_string"
          
            # è®¾ç½® tag_name è¾“å‡ºä¸ºæå–çš„ç‰ˆæœ¬å­—ç¬¦ä¸²
            echo "tag_name=$version_string" >> $GITHUB_OUTPUT
          
            # è®¾ç½® name è¾“å‡ºä¹Ÿä¸ºæå–çš„ç‰ˆæœ¬å­—ç¬¦ä¸²
            echo "release_name=$version_string" >> $GITHUB_OUTPUT
          
            # è®¡ç®— SHA
            sha_v8a=$(sha256sum "$apk_file_v8a" | awk '{print $1}')
            echo "sha_v8a=$sha_v8a" >> $GITHUB_OUTPUT
          
            # ç”Ÿæˆæ‘˜è¦
            {
              echo "### OShin Build Success :rocket:"
              echo ""
              echo "| Architecture | SHA256 Hash |"
              echo "|:---|:---|"
              echo "| arm64-v8a | \`$sha_v8a\` |"
            } >> $GITHUB_STEP_SUMMARY

      # ç¬¬ 6 æ­¥ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OShin-Build-${{ github.sha }} # ä¸ºäº§ç‰©åŒ…æŒ‡å®šä¸€ä¸ªåŒ…å«æäº¤IDçš„å”¯ä¸€åç§°ã€‚
          path: app/build/outputs/apk/release/ # ä¸Šä¼  release ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ã€‚

      - name: Create Release and Upload Asset to OShin-Builds
        uses: softprops/action-gh-release@v1
        with:
          repository: suqi8/OShin-Builds
          token: ${{ secrets.PUSH_TOKEN }}
          # ä½¿ç”¨æå–çš„ç‰ˆæœ¬å­—ç¬¦ä¸²ä½œä¸º tag_name
          tag_name: ${{ steps.artifacts.outputs.tag_name }}
          # ä½¿ç”¨æå–çš„ç‰ˆæœ¬å­—ç¬¦ä¸²ä½œä¸º Release çš„ Name
          name: ${{ steps.artifacts.outputs.release_name }}
          body: |
            Automatic CI build based on commit: ${{ github.sha }}
            Commit message: ${{ github.event.head_commit.message }}
          prerelease: false
          files: ${{ env.APK_FILE_V8A }}

      # ç¬¬ 7 æ­¥ï¼šé¢„å¤„ç†æäº¤ä¿¡æ¯ï¼Œæ¸…é™¤ Markdown å±é™©å­—ç¬¦å¹¶ä¿ç•™æ¢è¡Œ
      - name: Sanitize multiline commit message for Telegram
        run: |
          echo "å¤„ç†æäº¤ä¿¡æ¯ï¼Œæ¸…ç†ç‰¹æ®Šå­—ç¬¦..."
          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "${{ github.event.head_commit.message }}" \
            | sed 's/[\\`*_()\[\]]/ /g' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ç¬¬ 8 æ­¥ï¼šå‘é€ Telegram é€šçŸ¥
      - name: Send Notification to Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }} # Telegram æ¥æ”¶è€…çš„ Chat ID
          token: ${{ secrets.TELEGRAM_TOKEN }} # Telegram Bot çš„ Token
          document: ${{ env.APK_FILE_V8A }} # åŒ…å«æ‰€æœ‰æ¶æ„çš„ APK æ–‡ä»¶
          message: |
            ğŸš€ **OShin New CI Buildï¼**

            ${{ env.COMMIT_MSG }}
            ğŸ”— [æŸ¥çœ‹æœ¬æ¬¡æäº¤](${{ github.event.head_commit.url }})
